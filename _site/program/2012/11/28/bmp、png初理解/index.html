
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>bmp、png初理解</title>
    
    <meta name="author" content="Xinzheng Zhang">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.2.2.2.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/twitter/css/pygments.css?body=1" rel="stylesheet" type="text/css" media="all">
    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

    <!-- atom & rss feed -->
    <link href="" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>
    <div class="navbar">
      <div class="navbar-inner">
        <div class="container-narrow">
          <a class="brand" href="/">Snorlax's blog</a>
          <ul class="nav">
            
            
            


  
    
      
      	
      	<li><a href="/about.html">About me</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/archive.html">Archives</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  




          </ul>
        </div>
      </div>
    </div>
    <div class="container_wrapper">
      <div class="container-narrow">
        <div class="content">
          
<div class="page-header">
  <h1>bmp、png初理解 </h1>
</div>

<div class="row-fluid post-full">
  <div class="span12">
    <div class="date">
      <span>28 November 2012</span>
    </div>
    <div class="content">
      <p>主要还是写下bmp图的操作(另外两个看的实在头大<br />
首先bmp的头是由三部分组成的、分别是位图头、位图信息、调色板<br />
下面就是位图数据了<br />
详见<a href="http://zh.wikipedia.org/zh/BMP#.E8.B0.83.E8.89.B2.E6.9D.BF">http://zh.wikipedia.org/zh/BMP#.E8.B0.83.E8.89.B2.E6.9D.BF</a>
我用了以下的三个结构体用来接bmp头 然后再一个来接像素数据
<pre lang="c" colla="+">//
//  BmpLab.h
//  labfor12c
//
//  Created by zxz on 12-11-28.
//  Copyright (c) 2012年 zxz. All rights reserved.
//</pre></p>

<p>#ifndef labfor12c___BmpLab_h<br />
#define labfor12c___BmpLab_h</p>

<p>typedef struct __BitMapHead{<br />
//    __uint16_t fileType;  //default BM<br />
    __uint32_t fileSize;<br />
    __uint32_t unDefined; //undefined<br />
    __uint32_t fileOffset;<br />
}BitMapHead;</p>

<p>typedef struct __BitMapInfo{<br />
    __uint32_t infoHeadSize; //40<br />
    __uint32_t bitMapWidth;<br />
    __uint32_t bitMapHeight;<br />
    __uint16_t bitMapColorPlanes; //彩色位面的个数（不懂<br />
    __uint16_t bitMapPixelBit; //1 4 8 灰阶 24彩<br />
    __uint32_t bitMapCompression; //0 - 没有压缩（也用BI_RGB表示）    1 - 行程长度编码 8位/像素（也用BI_RLE8表示）    2 - 行程长度编码4位/像素（也用BI_RLE4表示）    3 - Bit field（也用BI_BITFIELDS表示）    4 - JPEG图像（也用BI_JPEG表示）    5 - PNG图像（也用BI_PNG表示）<br />
    __uint32_t bitMapBodySize;<br />
    __uint32_t bitMapXPixel;  //水平分辨率<br />
    __uint32_t bitMapYPixel;  //垂直分辨率<br />
    __uint32_t bitMapColorUsed;<br />
    __uint32_t bitMapImportantColorUsed;</p>

<p>}BitMapInfo;</p>

<p>typedef struct __RGBQUARD{<br />
    __uint8_t rgbRed;<br />
    __uint8_t rgbGreen;<br />
    __uint8_t rgbBlue;<br />
    __uint8_t rgbReserved;<br />
}RGBQUARD;</p>

<p>typedef struct __pixelData<br />
{
    __uint8_t blue;<br />
    __uint8_t green;<br />
    __uint8_t red;<br />
}pixelData;<br />
#endif</p>

<p>再然后就是把文件rb打开分别用上面的结构体接就可以了<br />
其中要注意的下因为type是2个字节的、结构体是会补齐的也就是如果直接一起读进去后面都会乱的<br />
所以我把type从结构体里注释了、选择先读进2个字节、然后再一并读进去
<pre lang="c" colla="-">
//
//  main.c
//  labfor12c
//
//  Created by zxz on 12-11-26.
//  Copyright (c) 2012年 zxz. All rights reserved.
//</pre></p>

<p>#include <stdio.h>
#include <stdlib.h>
#include "BmpLab.h"</stdlib.h></stdio.h></p>

<p>BitMapHead head;<br />
BitMapInfo info;<br />
RGBQUARD color[256];<br />
int main(int argc, const char * argv[])<br />
{</p>

<p>    FILE *fpr,*fpw;<br />
    fpr=fopen("test_binaryImg.bmp", "rb");<br />
    if (!fpr) {<br />
        printf("open fail");<br />
    }<br />
    else<br />
    {<br />
        __uint16_t type;<br />
        fread(&type, 1, sizeof(__uint16_t), fpr);<br />
        if (type!=0x4d42) {<br />
            printf("not a bmp file");<br />
            return 1;<br />
        }<br />
        fread(&head, 1, sizeof(BitMapHead), fpr);<br />
        fread(&info, 1, sizeof(BitMapInfo), fpr);<br />
        unsigned int nCounti=0;<br />
        for(nCounti=0;nCounti<info.bitMapColorUsed;nCounti++)<br />
        {<br />
            fread((char *)&(color[nCounti].rgbBlue),1,sizeof(__uint8_t),fpr);<br />
            fread((char *)&(color[nCounti].rgbGreen),1,sizeof(__uint8_t),fpr);<br />
            fread((char *)&(color[nCounti].rgbRed),1,sizeof(__uint8_t),fpr);<br />
            fread((char *)&(color[nCounti].rgbReserved),1,sizeof(__uint8_t),fpr);<br />
        }<br />
    }<br />
    __uint8_t *imgdata=(__uint8_t*)malloc(info.bitMapWidth*((sizeof(pixelData)+3)&~4)*info.bitMapHeight); //向4取整（早上学完装逼的方法马上来用……<br />
    fread(imgdata, sizeof(pixelData)*info.bitMapWidth, info.bitMapHeight, fpr);<br />
    //deal with the preix<br />
    return 0;<br />
}</p>

<p>
往回保存的时候修改下头里面的数据然后往回写即可</p>

<p>接着是png和jpeg、开始我 以为的是他们和位图一样简单呢……我还是太年轻了……<br />
还是先看下png的头吧<br />
png的头首先是一个8个字节的标示<br />
89 50 4E 47 0D 0A 1A 0A<br />
接下去是4个标准数据块<br />
分别是文件头数据块IHDR(header chunk)：包含有图像基本信息，作为第一个数据块出现并只出现一次。<br />
调色板数据块PLTE(palette chunk)：必须放在图像数据块之前。<br />
图像数据块IDAT(image data chunk)：存储实际图像数据。PNG数据允许包含多个连续的图像数据块。<br />
图像结束数据IEND(image trailer chunk)：放在文件尾部，表示PNG数据流结束。</p>

<p>其中的每个数据块的结构是<br />
Length(长度)	4字节	 指定数据块中数据域的长度，其长度不超过(231－1)字节<br />
Chunk Type Code(数据块类型码)	4字节	 数据块类型码由ASCII字母(A-Z和a-z)组成<br />
Chunk Data(数据块数据)	可变长度	 存储按照Chunk Type Code指定的数据<br />
CRC(循环冗余检测)	4字节	 存储用来检测是否有错误的循环冗余码</p>

<p>每块数据块的具体详见<a href="http://dev.gameres.com/Program/Visual/Other/PNGFormat.htm">http://dev.gameres.com/Program/Visual/Other/PNGFormat.htm</a>
又是CRC什么的一搞就没兴趣去写代码解析了……<br />
原来png jpeg这种头格式上半毛钱都关系不上啊……
</p>

    </div>

  
    <ul class="tag_box inline">
      <li><i class="icon-folder-open"></i></li>
      
      


  
    
    	<li><a href="#program-ref">
    		program <span>39</span>
    	</a></li>
    
  



    </ul>
  

  

    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/program/2012/11/24/regexkit%E7%AC%94%E8%AE%B0" title="RegexKit笔记">&larr; Previous</a></li>
      
        <li><a href="/archive.html">Archive</a></li>
      
        <li class="next"><a href="/program/2012/12/03/ios%E5%87%A0%E7%A7%8D%E5%9F%BA%E6%9C%AC%E8%A7%86%E5%9B%BE%E5%88%87%E6%8D%A2%E5%8A%A8%E7%94%BB%E5%B0%8F%E7%BB%93" title="ios几种基本视图切换动画小结">Next &rarr;</a></li>
      
      </ul>
    </div>
    <hr>
    


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'snorlaxzxz'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




  </div>
</div>


        </div>
        <hr>
        <footer>
          <p>&copy; 2014 Xinzheng ZhangPowered by Jekyll @ GitHub
          </p>
        </footer>

      </div>
    </div>
    
  </body>
</html>

